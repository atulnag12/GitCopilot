#!/usr/bin/env python3

import zipfile
import difflib


def extract_jar_contents(jar_path):
    """Extracts the content of a JAR file into a dictionary."""
    jar_contents = {}
    with zipfile.ZipFile(jar_path, 'r') as jar:
        for file in jar.namelist():
            if not file.endswith('/'):  # Ignore directories
                jar_contents[file] = jar.read(file).decode('utf-8', errors='ignore')
    return jar_contents


def generate_html_report(contents1, contents2):
    """Generates an HTML report for only the files with 'Different' status."""
    html_content = '''
    <html>
    <head>
        <style>
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th, td {
                padding: 8px 12px;
                border: 2px solid black;
                text-align: left;
            }
            th {
                background-color: #f2f2f2;
            }
            hr {
                border: 2px solid #000;
                margin-top: 20px;
                margin-bottom: 20px;
            }
        </style>
    </head>
    <body>
        <h2>JAR File Comparison Report</h2>
        <hr>
        <table>
            <thead>
                <tr>
                    <th>File Name</th>
                    <th>Status</th>
                    <th>Content Differences</th>
                </tr>
            </thead>
            <tbody>
    '''

    all_files = set(contents1.keys()) | set(contents2.keys())

    for file in sorted(all_files):
        if file in contents1 and file in contents2:
            if contents1[file] != contents2[file]:  # Only show different files
                status = "Different"
                diff = '\n'.join(difflib.unified_diff(
                    contents1[file].splitlines(),
                    contents2[file].splitlines(),
                    lineterm=""
                ))
                diff_content = f"--- Differences:\n<pre>{diff}</pre>"
                html_content += f'''
                <tr>
                    <td>{file}</td>
                    <td>{status}</td>
                    <td>{diff_content}</td>
                </tr>
                '''

    html_content += '''
            </tbody>
        </table>
        <hr>
    </body>
    </html>
    '''

    return html_content


if __name__ == "__main__":
    import sys

    if len(sys.argv) != 3:
        print("Usage: compare_jars.py <path_to_jar1> <path_to_jar2>")
        sys.exit(1)

    jar1_path = sys.argv[1]
    jar2_path = sys.argv[2]

    # Extract JAR contents
    jar1_contents = extract_jar_contents(jar1_path)
    jar2_contents = extract_jar_contents(jar2_path)

    # Generate HTML report
    html_report = generate_html_report(jar1_contents, jar2_contents)

    # Print the report (this will be captured by Ansible)
    print(html_report)
